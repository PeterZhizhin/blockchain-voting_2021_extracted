// console.log('hello mos.ru!!!');

$(function () {
	var field_over = false;

	$('.hint').hover(function () {
		$(this).addClass('hint--visible');
		field_over = true;
	}, function () {
		field_over = false
		setTimeout(() => {
			if (!field_over) {
				$(this).removeClass('hint--visible');
			}
		}, 100);
	}
	);

	$('.field__input').focus(function () {
		var $field = $(this).closest('.field');
		$field.addClass('field--focused');
	});

	$('.field__input').blur(function () {
		var $field = $(this).closest('.field');

		$field.removeClass('field--focused');
		$(this).prop('readonly', 'readonly');
	});

	$('.field__input').on('keyup change', function () {
		var $field = $(this).closest('.field');

		if ($.trim($(this).val()) === '') {
			$field.removeClass('field--filled');
		} else {
			$field.addClass('field--filled');
		}
	});

	$('.field__input').on('click', function () {
		$(this).prop('readonly', '');
		$(this).focus();
	});

	$('.field__clear').click(function () {
		var $field = $(this).closest('.field');
		var $input = $field.find('.field__input');
		$field.removeClass('field--filled');
		$input.val('');
	});

	$('.AboutService__toggle-btn').click(function (e) {
		var $toggle = $(this).closest('.AboutService__toggle');
		var $el = $toggle.closest('.AboutService');
		var $content = $el.find('.MosCollapse__content');
		var $contentHeight = $content.find('.MosCollapse__contentBox').outerHeight();
		var $icon = $toggle.find('.AboutService__toggle-icon');
		var $iconInfoContent = '<svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18"><g fill="none" fill-rule="evenodd"><path fill="#FFF" fill-rule="nonzero" stroke="#D6DAE0" stroke-width="1.25" d="M.625 9A8.374 8.374 0 0 0 9 17.375 8.374 8.374 0 0 0 17.375 9 8.374 8.374 0 0 0 9 .625 8.374 8.374 0 0 0 .625 9z" class="circle"></path><path fill="#333" d="M8.56 5.838h1.372V4.2H8.56v1.638zM8.546 14h1.386V7.084H7.706L7.3 8.218h1.246V14z"></path></g></svg>';
		var $iconCloseContent = '<svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18"><g fill="none" fill-rule="evenodd" transform="translate(-3 -3)"><rect width="16.75" height="16.75" x="3.625" y="3.625" fill="#FFF" stroke="#D6DAE0" stroke-width="1.25" class="circle" rx="8.375"></rect><path fill="#333" d="M10.918 11.978l-2.829 2.829a.75.75 0 0 0 1.06 1.06l2.83-2.828 2.828 2.828a.75.75 0 1 0 1.06-1.06l-2.828-2.829 2.828-2.828a.75.75 0 1 0-1.06-1.06l-2.829 2.828L9.15 8.089a.75.75 0 0 0-1.06 1.06l2.828 2.83z"></path></g></svg>'

		if ($toggle.hasClass('active')) {
			$el.removeClass('active');
			$toggle.removeClass('active');
			$icon
				.removeClass('TooltipClose')
				.addClass('TooltipInfo')
				.html($iconInfoContent);
			$content.css('height', 0);

			setTimeout(() => {
				$content
					.removeClass('MosCollapse__content_active')
					.addClass('MosCollapse__content_inactive');
			}, 350);
		} else {
			$el.addClass('active');
			$toggle.addClass('active');
			$icon
				.removeClass('TooltipInfo')
				.addClass('TooltipClose')
				.html($iconCloseContent);
			$content.css('height', $contentHeight + 'px');

			setTimeout(() => {
				$content
					.removeClass('MosCollapse__content_inactive')
					.addClass('MosCollapse__content_active');
			}, 350);
		}
	});

	$('.field__input').on('autocompletechange', function (event, ui) {
		$(event.currentTarget).trigger('change');
	});

	$('.js-datepicker').datepicker({
		changeMonth: true,
		changeYear: true,
	});


	

	initSelects();
});

function initSelects() {
	function setSelectFieldLabel(select) {
		var field = select.closest('div.field');
		var labelText = select.attr('data-label');
		var labelTpl = '<label class="field__label">' +
			'<span class="field__label-inner">' + labelText + '</span> ' +
			'</label>';

		if (field.find('.field__label').length === 0) {
			field.append(labelTpl);
		}
	}

	$('.js-select').selectpicker({
		styleBase: 'form-control field__input',
		style: '',
		dropupAuto: false,
		noneSelectedText: '',
		noneResultsText: 'Не найдено {0}'
	});

	$('.js-select').on('loaded.bs.select', function (e, clickedIndex, isSelected, previousValue) {
		setSelectFieldLabel($(e.target));
	});

	$('.js-select').on('show.bs.select', function (e, clickedIndex, isSelected, previousValue) {
		var selectEl = $(e.target);
		var fieldName = selectEl.attr('name');
		var field = selectEl.closest('div.field');
		var attrMultiple = selectEl.attr('multiple');
		var attrLiveSearch = selectEl.attr('data-live-search');

		field.addClass('field--focused');

		if (typeof attrLiveSearch !== 'undefined' && attrLiveSearch === 'true' && field.find('.field__clear').length === 0) {
			var clearTpl = $('<div class="field__clear"></div>');
			field.append(clearTpl);
			field.find(clearTpl).click(function (e) {
				selectEl.val('default');
				selectEl.selectpicker('refresh');
			});
		}

		if (typeof attrMultiple !== 'undefined') {
			field.find('.dropdown-menu.inner .dropdown-item').each(function (index, element) {
				var item = $(element);
				var id = fieldName + '_' + index;
				var text = item.attr('data-text') || item.find('.text').text();
				var checkboxTpl = '<div class="custom-control custom-checkbox">' +
					'<input type="checkbox" class="custom-control-input" id="' + id + '" >' +
					'<label class="custom-control-label" for="' + id + '">' + text + '</label>' +
					'</div>';

				item.attr('data-text', text);
				item.html(checkboxTpl);
				if (item.hasClass('selected')) {
					item.find('input[type="checkbox"]').prop('checked', true);
				}
			});
		}
	});


	$('.js-select').on('hide.bs.select', function (e, clickedIndex, isSelected, previousValue) {
		var selectEl = $(e.target);
		var field = selectEl.closest('div.field');

		if (selectEl.val() === '') {
			field.removeClass('field--filled');
		}

		field.removeClass('field--focused');
	});

	$('.js-select').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
		var selectEl = $(e.target);
		var field = selectEl.closest('div.field');

		if (selectEl.val() !== '') {
			field.addClass('field--filled');
		}

		if (clickedIndex) {
			field.find('.dropdown-menu.inner li:nth-child(' + (clickedIndex) + ') input[type="checkbox"]').prop('checked', isSelected);
		}
	});

	$('.js-select').on('shown.bs.select', function (e, clickedIndex, isSelected, previousValue) {
		var selectEl = $(e.target);
		var field = selectEl.closest('div.field');

		field.find('div.inner').scroll(function () {
			if ($(this).scrollTop() === 0) {
				field.removeClass('is-dropdown-list-scrolled');
			} else {
				field.addClass('is-dropdown-list-scrolled');
			}
		});

		// Подстановка значений при навигации через клавиатуру
		field.find('.bs-searchbox .form-control').on('keyup.bs.dropdown.data-api', function (e) {

			if (e.keyCode == 38 || e.keyCode == 40) {
				field.find('.form-control').val(field.find('li.active .text').text())
				field.addClass('field--filled');
			}
		});
	});

	$(document).on('click', '.field-select .field__clear', function (e) {
		var field = $(e.target).closest('.field')
		var selectEl = field.find('select');
		selectEl.val('default');
		selectEl.selectpicker('refresh');
		field.removeClass('field--filled');
	});
}